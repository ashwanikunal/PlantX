<!DOCTYPE html>
<html>
<head>
  <title>Ward-wise Heat Priority</title>

  <link rel="stylesheet" href="leaflet.css">
  <script src="leaflet.js"></script>
  <script src="shp.min.js"></script>

  <style>
    body { margin:0; display:flex; font-family:Arial; }
    #map-container { position:relative; width:75%; height:100vh; }
    #map { width:100%; height:100%; }

    #panel {
      width:25%;
      padding:12px;
      border-left:1px solid #ccc;
      background:#fafafa;
      overflow-y:auto;
    }

    .ward-label {
      font-size:10px;
      font-weight:600;
      background:rgba(255,255,255,0.6);
      padding:1px 3px;
      border-radius:3px;
    }

    #shade-bar {
      position:absolute;
      bottom:30px;
      left:15px;
      width:40px;
      height:220px;
      background:white;
      border-radius:6px;
      padding:6px;
      box-shadow:0 0 6px rgba(0,0,0,0.3);
      font-size:11px;
      font-weight:bold;
      z-index:1000;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    .shade-gradient {
      flex:1;
      width:100%;
      margin:4px 0;
      border-radius:4px;
      background: linear-gradient(
        to bottom,
        rgb(255,0,0),
        rgb(200,50,50),
        rgb(150,90,90),
        rgb(100,120,120),
        rgb(0,153,150)
      );
    }
  </style>
</head>

<body>

<div id="map-container">
  <div id="map"></div>
  <div id="shade-bar">
    <div>Highest</div>
    <div class="shade-gradient"></div>
    <div>Low</div>
  </div>
</div>

<div id="panel">
  <h3>Ward Priority</h3>
  <input type="file" id="upload" accept=".zip"><br><br>

  <h4>What-If: Increase Green Cover</h4>
  <input type="range" id="greenSlider" min="0" max="30" value="0">
  <span id="greenValue">0%</span><br><br>

  <button id="pdfBtn">Download Top-10 PDF</button>
  <div id="list"></div>
</div>

<script>
/* ---------- BASE MAPS ---------- */
const street = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");
const satellite = L.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}", {subdomains:["mt0","mt1","mt2","mt3"]});
const terrain = L.tileLayer("https://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}", {subdomains:["mt0","mt1","mt2","mt3"]});
const dark = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png");

/* ---------- MAP ---------- */
const map = L.map("map", {
  center:[23.03,72.58],
  zoom:11,
  layers:[street]
});

const wardGroup = L.layerGroup().addTo(map);

L.control.layers(
  {Street:street, Satellite:satellite, Terrain:terrain, Dark:dark},
  {"Ward Priority": wardGroup},
  {collapsed:false}
).addTo(map);

/* ---------- COLOR ---------- */
function getColor(v){
  v=Math.max(0,Math.min(1,v));
  return `rgb(${255*v},${255*(1-v)*0.6},${150*(1-v)})`;
}

/* ---------- AI WINDOW ---------- */
async function openAIExplanation(props){
  const res = await fetch("http://localhost:8000/explain-ward",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(props)
  });
  const data = await res.json();

  const w = window.open("","_blank","width=650,height=500");
  w.document.write(`<h2>${data.ward_name}</h2><pre>${data.analysis}</pre>`);
}

/* ---------- LOAD DATA ---------- */
let lastGeoJSON=null;

document.getElementById("upload").onchange = async e => {
  const geojson = await shp(await e.target.files[0].arrayBuffer());
  lastGeoJSON = geojson;

  const res = await fetch("http://localhost:8000/ward-priority",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({geojson})
  });

  const data = await res.json();
  wardGroup.clearLayers();

  const layer = L.geoJSON(data,{
    style:f=>({
      color:"#333",
      weight:0.6,
      fillColor:getColor(f.properties.p75||0),
      fillOpacity:0.75
    }),
    onEachFeature:(f,l)=>{
      l.bindTooltip(f.properties.ward_name,{permanent:true,className:"ward-label"});
      l.on("dblclick",()=>openAIExplanation(f.properties));
      l.on("mouseover",()=>l.setStyle({weight:2}));
      l.on("mouseout",()=>l.setStyle({weight:0.6}));
    }
  });

  wardGroup.addLayer(layer);
  map.fitBounds(layer.getBounds());

  document.getElementById("list").innerHTML =
    data.features
      .sort((a,b)=>b.properties.p75-a.properties.p75)
      .map(f=>`<div><b>${f.properties.ward_name}</b> â€“ ${f.properties.p75.toFixed(2)}</div>`)
      .join("");
};

/* ---------- WHAT-IF ---------- */
const slider=document.getElementById("greenSlider");
slider.oninput=()=>{
  document.getElementById("greenValue").innerText=slider.value+"%";
  wardGroup.eachLayer(g=>{
    g.eachLayer(l=>{
      const base=l.feature.properties.p75||0;
      l.setStyle({fillColor:getColor(Math.max(0,base-slider.value*0.01))});
    });
  });
};
</script>
</body>
</html>
