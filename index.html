<!DOCTYPE html>
<html>
<head>
  <title>Ward-wise Heat Priority</title>

  <!-- Local Leaflet files -->
  <link rel="stylesheet" href="leaflet.css">
  <script src="leaflet.js"></script>
  <script src="shp.min.js"></script>

  <style>
    body { margin:0; display:flex; font-family:Arial; }
    #map { width:75%; height:100vh; }
    #panel {
      width:25%;
      padding:12px;
      overflow-y:auto;
      border-left:1px solid #ccc;
      background:#fafafa;
    }
    .ward { padding:8px; border-bottom:1px solid #ddd; }
    button { width:100%; margin-top:10px; padding:8px; }

    /* Ward name labels */
    .ward-label {
      font-size: 11px;
      font-weight: bold;
      color: #000;
      background: rgba(255,255,255,0.7);
      border: none;
      box-shadow: none;
      text-align: center;
    }
  </style>
</head>

<body>

<div id="map"></div>

<div id="panel">
  <h3>Ward Priority List</h3>
  <input type="file" id="upload" accept=".zip"><br><br>
  <button id="pdfBtn">Download Top-10 PDF</button>
  <div id="list"></div>
</div>

<script>
/* ---------------- MAP INIT ---------------- */
const map = L.map("map").setView([23.03, 72.58], 11);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap"
}).addTo(map);

const wardGroup = L.layerGroup().addTo(map);



/* ---------------- COLOR SCALE ---------------- */
function getColor(v) {
  // clamp value between 0 and 1
  v = Math.max(0, Math.min(1, v));

  // smooth gradient: yellow → red → dark purple
  const r = Math.round(255 * v);
  const g = Math.round(255 * (1 - v) * 0.6);
  const b = Math.round(150 * (1 - v));

  return `rgb(${r}, ${g}, ${b})`;
}

let lastGeoJSON = null;

/* ---------------- SHAPEFILE UPLOAD ---------------- */
document.getElementById("upload").addEventListener("change", async e => {
  const buffer = await e.target.files[0].arrayBuffer();
  const geojson = await shp(buffer);
  lastGeoJSON = geojson;

  const res = await fetch("http://localhost:8000/ward-priority", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ geojson })
  });

  const data = await res.json();

  wardGroup.clearLayers();

  const layer = L.geoJSON(data, {
    style: f => ({
      color: "#333",
      weight: 0.6,
      fillColor: getColor(f.properties.p75 || 0),
      fillOpacity: 0.75
    }),
    onEachFeature: (f, l) => {

      // Popup
      l.bindPopup(
        `<b>Ward:</b> ${f.properties.ward_name}<br>
         <b>Priority:</b> ${(f.properties.p75 || 0).toFixed(2)}`
      );

      // Ward name on map
      l.bindTooltip(
        f.properties.ward_name || "Unnamed",
        {
          permanent: true,
          direction: "center",
          className: "ward-label"
        }
      );
    }
  });

  wardGroup.addLayer(layer);
  map.fitBounds(layer.getBounds());

  // Side panel list
  const list = document.getElementById("list");
  list.innerHTML = "";

  data.features
    .sort((a,b) => (b.properties.p75 || 0) - (a.properties.p75 || 0))
    .forEach(f => {
      list.innerHTML += `
        <div class="ward">
          <b>${f.properties.ward_name}</b><br>
          Priority: ${(f.properties.p75 || 0).toFixed(2)}
        </div>`;
    });

  // Hide labels at low zoom
  map.on("zoomend", () => {
    const z = map.getZoom();
    layer.eachLayer(l => {
      if (z >= 12) l.openTooltip();
      else l.closeTooltip();
    });
  });
});

/* ---------------- PDF DOWNLOAD ---------------- */
document.getElementById("pdfBtn").onclick = async () => {
  if (!lastGeoJSON) {
    alert("Upload wards first");
    return;
  }

  const res = await fetch("http://localhost:8000/top10-pdf", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ geojson: lastGeoJSON })
  });

  const data = await res.json();
  console.log(data.features[0].properties);
  const a = document.createElement("a");
  a.href = "http://localhost:8000/" + data.file;
  a.download = "Top10_Wards.pdf";
  a.click();

};
</script>

</body>
</html>
